---
allowed-tools: Read, Write, MultiEdit, Bash(deno:*), Bash(fd:*), Bash(bat:*), Bash(jq:*), Bash(gdate:*), Bash(mkdir:*)
description: Scaffold production-ready Deno automation script with Dax integration and deno.json task registration
---

## Context

- Session ID: !`gdate +%s%N 2>/dev/null || date +%s%N 2>/dev/null || echo "$(date +%s)$(jot -r 1 100000 999999 2>/dev/null || shuf -i 100000-999999 -n 1 2>/dev/null || echo $RANDOM$RANDOM)"`
- Current directory: !`pwd`
- Script name: $ARGUMENTS
- Project structure: !`fd "deno\.json" . -d 2 | head -3 || echo "No deno.json found - will create"`
- Scripts directory status: !`fd scripts . -t d -d 2 | head -1 || echo "No scripts directory - will create"`
- Existing scripts: !`fd "\.ts$" scripts/ 2>/dev/null | wc -l | tr -d ' ' || echo "0"` TypeScript files
- Deno version: !`deno --version | head -1 2>/dev/null || echo "Deno not found"`
- Modern tools status: !`echo "fd: $(which fd >/dev/null && echo ‚úì || echo ‚úó) | bat: $(which bat >/dev/null && echo ‚úì || echo ‚úó) | jq: $(which jq >/dev/null && echo ‚úì || echo ‚úó)"`

## Your Task

STEP 1: Initialize session state and validate project context

- CREATE session state file: `/tmp/scaffold-script-session-$SESSION_ID.json`
- VALIDATE script name from $ARGUMENTS (must be provided)
- VERIFY Deno installation and project structure
- DETERMINE project type and existing configuration

```bash
# Initialize scaffold session state
echo '{
  "sessionId": "'$SESSION_ID'",
  "scriptName": "'$ARGUMENTS'",
  "projectRoot": "'$(pwd)'",
  "timestamp": "'$(gdate -Iseconds 2>/dev/null || date -Iseconds)'",
  "scaffoldingSteps": [],
  "daxConfigured": false,
  "taskRegistered": false
}' > /tmp/scaffold-script-session-$SESSION_ID.json
```

IF script_name is empty:

- DISPLAY usage guidance: "Usage: /scaffold-deno-script [script-name]"
- SUGGEST examples: "cleanup-logs", "deploy-app", "sync-data"
- EXIT with helpful message

STEP 2: Project structure analysis and preparation

TRY:

**Directory Structure Setup:**

```bash
# Ensure scripts directory exists
if ! fd scripts . -t d -d 1 >/dev/null 2>&1; then
  echo "üìÅ Creating scripts directory..."
  mkdir -p scripts
fi

# Check for deno.json configuration
if ! fd "deno\.json" . -d 1 >/dev/null 2>&1; then
  echo "‚ö†Ô∏è No deno.json found - will create minimal configuration"
fi
```

**Existing Script Analysis:**

```bash
# Check for naming conflicts
if [[ -f "scripts/$ARGUMENTS.ts" ]]; then
  echo "‚ö†Ô∏è Script scripts/$ARGUMENTS.ts already exists"
  echo "Options: 1) Choose different name 2) Overwrite existing"
fi

# Analyze existing scripts for patterns
existing_count=$(fd "\.ts$" scripts/ 2>/dev/null | wc -l | tr -d ' ')
echo "üìä Found $existing_count existing TypeScript scripts"
```

STEP 3: Deno configuration management with smart updates

**deno.json Configuration:**

IF deno.json exists:

- READ current configuration
- CHECK for existing Dax dependency in imports section
- ADD Dax dependency if missing: `"@david/dax": "jsr:@david/dax@^0.42.0"`
- ADD task entry: `"$ARGUMENTS": "deno run --allow-all scripts/$ARGUMENTS.ts"`
- PRESERVE existing configuration structure

ELSE:

- CREATE comprehensive deno.json with:
  - JSR imports for Dax and standard library
  - Task definitions including new script
  - TypeScript compiler options
  - Standard project structure

```json
{
  "imports": {
    "@std/path": "jsr:@std/path@^1.0.9",
    "@std/fs": "jsr:@std/fs@^1.0.17",
    "@std/cli/parse-args": "jsr:@std/cli@^1.0.9",
    "@std/assert": "jsr:@std/assert@^1.0.9",
    "@david/dax": "jsr:@david/dax@^0.42.0"
  },
  "tasks": {
    "$ARGUMENTS": "deno run --allow-all scripts/$ARGUMENTS.ts",
    "check": "deno check **/*.ts",
    "fmt": "deno fmt",
    "lint": "deno lint"
  },
  "compilerOptions": {
    "strict": true
  }
}
```

STEP 4: Generate production-ready script template

**Comprehensive Script Template Creation:**

CREATE `scripts/$ARGUMENTS.ts` with:

- **Shebang line** for direct execution
- **JSR imports** for Dax and standard library
- **CLI argument parsing** using @std/cli/parse-args
- **Cross-platform operations** via Dax
- **Progress indicators** and colored output
- **Error handling** with proper exit codes
- **Async/await patterns** for modern TypeScript
- **Documentation** and usage examples

```typescript
#!/usr/bin/env -S deno run --allow-all

/**
 * $ARGUMENTS - Auto-generated Deno script with Dax integration
 *
 * Generated by Claude Code scaffold-deno-script command
 * Session: $SESSION_ID
 * Created: $(gdate -Iseconds 2>/dev/null || date -Iseconds)
 */

import { parseArgs } from "@std/cli/parse-args";
import { $, Path } from "@david/dax";
import { cyan, green, red, yellow } from "@std/fmt/colors";

// CLI argument parsing
const args = parseArgs(Deno.args, {
  boolean: ["help", "verbose", "dry-run"],
  string: ["input", "output"],
  alias: { h: "help", v: "verbose", d: "dry-run" },
});

if (args.help) {
  console.log(`
${cyan("üõ†Ô∏è  $ARGUMENTS Script")}

Usage:
  deno task $ARGUMENTS [options]
  deno run --allow-all scripts/$ARGUMENTS.ts [options]

Options:
  -h, --help      Show this help message
  -v, --verbose   Enable verbose output
  -d, --dry-run   Show what would be done without executing
  --input <path>  Input file or directory
  --output <path> Output file or directory

Examples:
  deno task $ARGUMENTS --verbose
  deno task $ARGUMENTS --input ./data --output ./processed
  `);
  Deno.exit(0);
}

// Main script functionality
async function main(): Promise<void> {
  try {
    console.log(cyan(`üöÄ Starting $ARGUMENTS script...`));

    if (args.verbose) {
      console.log(yellow(`üìä Arguments: ${JSON.stringify(args, null, 2)}`));
    }

    // Example: Cross-platform file operations
    const currentDir = new Path(".");
    console.log(green(`üìÅ Working directory: ${currentDir.toString()}`));

    // Example: Command execution with Dax
    if (args["dry-run"]) {
      console.log(yellow("üîç Dry run mode - showing planned operations:"));
      console.log("  - Would execute cross-platform commands");
      console.log("  - Would process files/directories");
      console.log("  - Would generate output");
    } else {
      // Replace with your actual script logic
      console.log(green("‚úÖ Script template ready for customization"));

      // Example Dax usage:
      // const result = await $("echo 'Hello from Dax!'").text();
      // console.log(`Command output: ${result.trim()}`);
    }

    console.log(green(`‚úÖ $ARGUMENTS completed successfully`));
  } catch (error) {
    console.error(red(`‚ùå Error in $ARGUMENTS: ${error.message}`));
    if (args.verbose) {
      console.error(red(error.stack));
    }
    Deno.exit(1);
  }
}

// Execute main function
if (import.meta.main) {
  await main();
}
```

STEP 5: Validation and testing setup

**Script Validation:**

```bash
# Type check the generated script
echo "üîç Type checking generated script..."
deno check scripts/$ARGUMENTS.ts

# Test script execution with help flag
echo "üß™ Testing script execution..."
deno run --allow-all scripts/$ARGUMENTS.ts --help

# Verify task registration
echo "üìã Verifying deno.json task registration..."
jq -r '.tasks | keys[]' deno.json 2>/dev/null | grep "^$ARGUMENTS$" || echo "Task not found in deno.json"
```

**Project Integration Test:**

```bash
# Test task execution
echo "‚ö° Testing deno task execution..."
deno task $ARGUMENTS --dry-run --verbose
```

CATCH (scaffolding_failed):

- LOG error details to session state
- PROVIDE troubleshooting guidance
- SUGGEST manual setup steps
- CLEAN UP partial files if necessary

```bash
echo "‚ö†Ô∏è Scaffolding failed. Common issues:"
echo "  - Insufficient permissions (try with elevated privileges)"
echo "  - Invalid script name (use kebab-case naming)"
echo "  - Missing Deno installation"
echo "  - Corrupted deno.json file"
echo "  - File system permissions"
```

STEP 6: Session completion and usage guidance

**Update Session State:**

```bash
# Update session state with completion status
jq --arg timestamp "$(gdate -Iseconds 2>/dev/null || date -Iseconds)" '
  .scaffoldingSteps += ["script_created", "deno_json_updated", "validation_passed"] |
  .daxConfigured = true |
  .taskRegistered = true |
  .completedAt = $timestamp
' /tmp/scaffold-script-session-$SESSION_ID.json > /tmp/scaffold-script-session-$SESSION_ID.tmp && \
mv /tmp/scaffold-script-session-$SESSION_ID.tmp /tmp/scaffold-script-session-$SESSION_ID.json
```

**Usage Guidance:**

```bash
echo "‚úÖ Script scaffolding completed successfully!"
echo ""
echo "üìÅ Created files:"
echo "  - scripts/$ARGUMENTS.ts (executable script with Dax integration)"
echo "  - Updated deno.json with task and dependencies"
echo ""
echo "üöÄ Usage options:"
echo "  deno task $ARGUMENTS --help    # Show script help"
echo "  deno task $ARGUMENTS --verbose # Run with detailed output"
echo "  deno task $ARGUMENTS --dry-run # Preview operations"
echo ""
echo "üîß Next steps:"
echo "  1. Customize the script logic in scripts/$ARGUMENTS.ts"
echo "  2. Add your specific automation functionality"
echo "  3. Test with: deno task $ARGUMENTS"
echo "  4. Use Dax for cross-platform shell operations"
echo ""
echo "‚è±Ô∏è Session: $SESSION_ID"
```

FINALLY:

- SAVE session state for debugging/reference
- PROVIDE integration examples for common use cases
- SUGGEST related scaffolding commands if applicable

## Script Template Features

### Modern Deno Patterns

- **JSR Imports**: Latest Deno standard library from JSR registry
- **Dax Integration**: Cross-platform shell operations without platform-specific code
- **CLI Parsing**: Robust argument parsing with @std/cli/parse-args
- **TypeScript Strict Mode**: Enhanced type safety and error detection

### Production Capabilities

- **Proper Error Handling**: Try/catch blocks with exit codes
- **Progress Indicators**: Colored output with status information
- **Dry Run Mode**: Preview operations without execution
- **Verbose Logging**: Detailed output for debugging
- **Help Documentation**: Built-in usage instructions

### Cross-Platform Features

- **Path Handling**: Dax Path utilities for file system operations
- **Command Execution**: Shell command execution via Dax $() syntax
- **Environment Variables**: Access to process environment
- **File Operations**: Read/write operations with proper error handling

### Integration Examples

**File Processing Script:**

```bash
/scaffold-deno-script process-images
# Creates script for batch image processing with progress tracking
```

**Deployment Automation:**

```bash
/scaffold-deno-script deploy-staging
# Creates deployment script with environment checks and rollback
```

**Data Synchronization:**

```bash
/scaffold-deno-script sync-databases
# Creates data sync script with validation and conflict resolution
```

**Log Management:**

```bash
/scaffold-deno-script cleanup-logs
# Creates log rotation and cleanup script with size/age management
```
